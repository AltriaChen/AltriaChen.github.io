<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  
  <link rel="stylesheet" href="/lib/animate-css/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Pisces","version":"8.0.0-rc.5","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false};
  </script>

  <meta name="description" content="本文介绍了抓包工具 Wireshark 的使用，以及介绍了 Python 的强力数据包处理模块 Scapy。">
<meta property="og:type" content="article">
<meta property="og:title" content="Python模块学习：Scapy以及Wireshark使用">
<meta property="og:url" content="http://yoursite.com/2023/06/24/Python_Module02/index.html">
<meta property="og:site_name" content="Cross Code">
<meta property="og:description" content="本文介绍了抓包工具 Wireshark 的使用，以及介绍了 Python 的强力数据包处理模块 Scapy。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://mwchen.oss-cn-hangzhou.aliyuncs.com/MyBlog/TP-LINK/TP03/A4301.jpg">
<meta property="og:image" content="https://mwchen.oss-cn-hangzhou.aliyuncs.com/MyBlog/TP-LINK/TP03/A4302.jpg">
<meta property="og:image" content="https://mwchen.oss-cn-hangzhou.aliyuncs.com/MyBlog/TP-LINK/TP03/A4303.jpg">
<meta property="og:image" content="https://mwchen.oss-cn-hangzhou.aliyuncs.com/MyBlog/TP-LINK/TP03/A4304.jpg">
<meta property="og:image" content="https://mwchen.oss-cn-hangzhou.aliyuncs.com/MyBlog/TP-LINK/TP03/A4305.jpg">
<meta property="og:image" content="https://mwchen.oss-cn-hangzhou.aliyuncs.com/MyBlog/TP-LINK/TP03/A4306.jpg">
<meta property="og:image" content="https://mwchen.oss-cn-hangzhou.aliyuncs.com/MyBlog/TP-LINK/TP03/A4307.jpg">
<meta property="og:image" content="https://mwchen.oss-cn-hangzhou.aliyuncs.com/MyBlog/TP-LINK/TP03/A4308.jpg">
<meta property="og:image" content="https://mwchen.oss-cn-hangzhou.aliyuncs.com/MyBlog/TP-LINK/TP03/A4309.jpg">
<meta property="og:image" content="https://mwchen.oss-cn-hangzhou.aliyuncs.com/MyBlog/TP-LINK/TP03/A4310.jpg">
<meta property="og:image" content="https://mwchen.oss-cn-hangzhou.aliyuncs.com/MyBlog/TP-LINK/TP03/A4311.jpg">
<meta property="og:image" content="https://mwchen.oss-cn-hangzhou.aliyuncs.com/MyBlog/TP-LINK/TP03/A4312.jpg">
<meta property="og:image" content="https://mwchen.oss-cn-hangzhou.aliyuncs.com/MyBlog/TP-LINK/TP03/A4313.jpg">
<meta property="og:image" content="https://mwchen.oss-cn-hangzhou.aliyuncs.com/MyBlog/TP-LINK/TP03/A4314.jpg">
<meta property="og:image" content="https://mwchen.oss-cn-hangzhou.aliyuncs.com/MyBlog/TP-LINK/TP03/A4315.jpg">
<meta property="og:image" content="https://mwchen.oss-cn-hangzhou.aliyuncs.com/MyBlog/TP-LINK/TP03/A4316.jpg">
<meta property="og:image" content="https://mwchen.oss-cn-hangzhou.aliyuncs.com/MyBlog/TP-LINK/TP03/A4317.jpg">
<meta property="og:image" content="https://mwchen.oss-cn-hangzhou.aliyuncs.com/MyBlog/TP-LINK/TP03/A4318.jpg">
<meta property="og:image" content="https://mwchen.oss-cn-hangzhou.aliyuncs.com/MyBlog/TP-LINK/TP03/A4319.jpg">
<meta property="og:image" content="https://mwchen.oss-cn-hangzhou.aliyuncs.com/MyBlog/TP-LINK/TP03/A4320.jpg">
<meta property="og:image" content="https://mwchen.oss-cn-hangzhou.aliyuncs.com/MyBlog/TP-LINK/TP03/A4321.jpg">
<meta property="og:image" content="https://mwchen.oss-cn-hangzhou.aliyuncs.com/MyBlog/TP-LINK/TP03/A4322.jpg">
<meta property="article:published_time" content="2023-06-24T02:42:20.000Z">
<meta property="article:modified_time" content="2023-11-09T23:29:32.447Z">
<meta property="article:author" content="Minwei Chen">
<meta property="article:tag" content="Python">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://mwchen.oss-cn-hangzhou.aliyuncs.com/MyBlog/TP-LINK/TP03/A4301.jpg">

<link rel="canonical" href="http://yoursite.com/2023/06/24/Python_Module02/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Python模块学习：Scapy以及Wireshark使用 | Cross Code</title>
  






  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

  <script type="text/javascript" src="/js/my_js/clicklove.js"></script>
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <main class="main">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader">
        <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Cross Code</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">There is only one heroism in the world: to see the world as it is and to love it</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <section class="post-toc-wrap sidebar-panel">
          <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%80-Wireshark"><span class="nav-text">一. Wireshark</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#A-%E6%A6%82%E8%BF%B0"><span class="nav-text">(A) 概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#B-%E4%BD%BF%E7%94%A8%E4%BB%8B%E7%BB%8D"><span class="nav-text">(B) 使用介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#C-%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C"><span class="nav-text">(C) 基础操作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#a-%E8%B0%83%E6%95%B4%E7%95%8C%E9%9D%A2%E5%A4%A7%E5%B0%8F"><span class="nav-text">(a) 调整界面大小</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#b-%E8%AE%BE%E7%BD%AE%E6%98%BE%E7%A4%BA%E5%88%97"><span class="nav-text">(b) 设置显示列</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E6%B7%BB%E5%8A%A0%E6%98%BE%E7%A4%BA%E5%88%97"><span class="nav-text">(1) 添加显示列</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E9%9A%90%E8%97%8F%E6%98%BE%E7%A4%BA%E5%88%97"><span class="nav-text">(2) 隐藏显示列</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-%E5%88%A0%E9%99%A4%E6%98%BE%E7%A4%BA%E5%88%97"><span class="nav-text">(3) 删除显示列</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#c-%E8%AE%BE%E7%BD%AE%E6%97%B6%E9%97%B4"><span class="nav-text">(c) 设置时间</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#d-%E6%A0%87%E8%AE%B0%E6%95%B0%E6%8D%AE%E5%8C%85"><span class="nav-text">(d) 标记数据包</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#e-%E5%AF%BC%E5%87%BA%E6%95%B0%E6%8D%AE%E5%8C%85"><span class="nav-text">(e) 导出数据包</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E5%AF%BC%E5%87%BA%E5%8D%95%E4%B8%AA%E6%95%B0%E6%8D%AE%E5%8C%85"><span class="nav-text">(1) 导出单个数据包</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E5%AF%BC%E5%87%BA%E5%A4%9A%E4%B8%AA%E6%95%B0%E6%8D%AE%E5%8C%85"><span class="nav-text">(2) 导出多个数据包</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#f-%E5%BC%80%E5%90%AF%E6%B7%B7%E6%9D%82%E6%A8%A1%E5%BC%8F"><span class="nav-text">(f) 开启混杂模式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#D-%E8%BF%87%E6%BB%A4%E5%99%A8%E6%93%8D%E4%BD%9C"><span class="nav-text">(D) 过滤器操作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#a-%E6%8A%93%E5%8C%85%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="nav-text">(a) 抓包过滤器</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-BPF-%E8%AF%AD%E6%B3%95"><span class="nav-text">(1) BPF 语法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="nav-text">(2) 使用方式</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#b-%E6%98%BE%E7%A4%BA%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="nav-text">(b) 显示过滤器</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E8%AF%AD%E6%B3%95%E7%BB%93%E6%9E%84"><span class="nav-text">(1) 语法结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F-1"><span class="nav-text">(2) 使用方式</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#c-%E8%BF%87%E6%BB%A4%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="nav-text">(c) 过滤表达式</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C-Scapy"><span class="nav-text">二. Scapy</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#A-%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C"><span class="nav-text">(A) 基本操作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#a-%E6%9F%A5%E7%9C%8B%E4%BF%A1%E6%81%AF"><span class="nav-text">(a) 查看信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#b-%E5%8F%91%E9%80%81%E4%B8%8E%E6%8E%A5%E6%94%B6%E6%95%B0%E6%8D%AE"><span class="nav-text">(b) 发送与接收数据</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-send-%E4%B8%8E-sendp"><span class="nav-text">(1) send 与 sendp</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-sr-%E4%B8%8E-sr1"><span class="nav-text">(2) sr 与 sr1</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-fuzz"><span class="nav-text">(3) fuzz</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#c-%E8%AF%BB%E5%86%99-pcap-pcapng-%E6%96%87%E4%BB%B6"><span class="nav-text">(c) 读写 pcap&#x2F;pcapng 文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#d-sniff-%E6%8A%93%E5%8C%85"><span class="nav-text">(d) sniff 抓包</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#B-%E6%9E%84%E9%80%A0%E5%8D%8F%E8%AE%AE%E6%8A%A5%E6%96%87"><span class="nav-text">(B) 构造协议报文</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#C-%E5%BA%94%E7%94%A8%E5%AE%9E%E4%BE%8B"><span class="nav-text">(C) 应用实例</span></a></li></ol></li></ol></div>
      </section>
      <!--/noindex-->

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Minwei Chen"
      src="/images/tuoqi.jpg">
  <p class="site-author-name" itemprop="name">Minwei Chen</p>
  <div class="site-description" itemprop="description">Cross the surface, get to the reality. Welcome to Cross Code!</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">44</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/AltriaChen" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;AltriaChen" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:mwchennju@foxmail.com" title="E-Mail → mailto:mwchennju@foxmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </section>
    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </header>

      
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div id="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


      <div class="main-inner">
        

        <div class="content post posts-expand">
          

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2023/06/24/Python_Module02/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/tuoqi.jpg">
      <meta itemprop="name" content="Minwei Chen">
      <meta itemprop="description" content="Cross the surface, get to the reality. Welcome to Cross Code!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cross Code">
    </span>

    
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Python模块学习：Scapy以及Wireshark使用
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-06-24 10:42:20" itemprop="dateCreated datePublished" datetime="2023-06-24T10:42:20+08:00">2023-06-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-11-10 07:29:32" itemprop="dateModified" datetime="2023-11-10T07:29:32+08:00">2023-11-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">Python笔记</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>本文介绍了抓包工具 Wireshark 的使用，以及介绍了 Python 的强力数据包处理模块 Scapy。</p>
<a id="more"></a>

<h1 id="一-Wireshark"><a href="#一-Wireshark" class="headerlink" title="一. Wireshark"></a>一. Wireshark</h1><h2 id="A-概述"><a href="#A-概述" class="headerlink" title="(A) 概述"></a>(A) 概述</h2><p><strong>(1) Wireshark 是什么</strong></p>
<p>Wireshark 是使用最广泛的一款开源抓包软件，常用来检测网络问题、攻击溯源、或者分析底层通信机制。它使用 WinPCAP 作为接口，直接与网卡进行数据报文交换。</p>
<p><strong>(2) Wireshark 抓包原理</strong></p>
<p>Wireshark 使用的环境大致分为两种，一种是电脑直连互联网的单机环境，另外一种就是应用比较多的互联网环境，也就是连接交换机的情况。单机情况下，Wireshark 直接抓取本机网卡的网络流量；交换机情况下，Wireshark 通过端口镜像、ARP 欺骗等方式获取局域网中的网络流量。<br>端口镜像：利用交换机的接口，将局域网的网络流量转发到指定电脑的网卡上。<br>ARP 欺骗：交换机根据 MAC 地址转发数据，伪装其他终端的 MAC 地址，从而获取局域网的网络流量。</p>
<p><strong>(3) 界面介绍</strong></p>
<p><img src="https://mwchen.oss-cn-hangzhou.aliyuncs.com/MyBlog/TP-LINK/TP03/A4301.jpg"></p>
<p>Wireshark 的主界面包含 6 个部分：</p>
<ol>
<li>菜单栏：用于调试、配置</li>
<li>工具栏：常用功能的快捷方式</li>
<li>过滤栏：指定过滤条件，过滤数据包</li>
<li>数据包列表：核心区域，每一行就是一个数据包</li>
<li>数据包详情：数据包的详细数据</li>
<li>数据包字节：数据包对应的字节流，二进制</li>
</ol>
<h2 id="B-使用介绍"><a href="#B-使用介绍" class="headerlink" title="(B) 使用介绍"></a>(B) 使用介绍</h2><p>这里介绍一下 Wireshark 的使用方法。</p>
<p><strong>(1) 选择网卡</strong></p>
<p>打开 Wireshark 后，会直接进入网卡选择界面，WLAN 是我们连接无线的网卡，我们抓一下这个网卡的流量，双击网卡名，自动开始抓包。</p>
<p><img src="https://mwchen.oss-cn-hangzhou.aliyuncs.com/MyBlog/TP-LINK/TP03/A4302.jpg"></p>
<p><strong>(2) 停止抓包</strong></p>
<p>点击左上角的红色按钮，可以停止抓包。</p>
<p><img src="https://mwchen.oss-cn-hangzhou.aliyuncs.com/MyBlog/TP-LINK/TP03/A4303.jpg"></p>
<p><strong>(3) 保存数据</strong></p>
<p>点击右上角的文件，选择保存，可以保存抓包的数据。</p>
<p><img src="https://mwchen.oss-cn-hangzhou.aliyuncs.com/MyBlog/TP-LINK/TP03/A4304.jpg"></p>
<p>也可以直接点击工具栏的保存按钮。</p>
<p><img src="https://mwchen.oss-cn-hangzhou.aliyuncs.com/MyBlog/TP-LINK/TP03/A4305.jpg"></p>
<h2 id="C-基础操作"><a href="#C-基础操作" class="headerlink" title="(C) 基础操作"></a>(C) 基础操作</h2><p>这里介绍一下 Wireshark 的常用操作。</p>
<h3 id="a-调整界面大小"><a href="#a-调整界面大小" class="headerlink" title="(a) 调整界面大小"></a>(a) 调整界面大小</h3><p>工具栏中的三个放大镜图标，可以调整主界面数据的大小。</p>
<p><img src="https://mwchen.oss-cn-hangzhou.aliyuncs.com/MyBlog/TP-LINK/TP03/A4306.jpg"></p>
<p>从左到右依次是：放大、缩小、还原默认大小。</p>
<h3 id="b-设置显示列"><a href="#b-设置显示列" class="headerlink" title="(b) 设置显示列"></a>(b) 设置显示列</h3><p>数据包列表是最常用的模块之一，列表中有一些默认显示的列，我们可以添加、删除、修改显示的列。</p>
<h4 id="1-添加显示列"><a href="#1-添加显示列" class="headerlink" title="(1) 添加显示列"></a>(1) 添加显示列</h4><p>想要在数据列表中显示某一个字段，可以将这个数据字段添加至显示列中。<br>左键选中想要添加为列的字段，右键选择应用为列。</p>
<p><img src="https://mwchen.oss-cn-hangzhou.aliyuncs.com/MyBlog/TP-LINK/TP03/A4307.jpg"></p>
<p>选中字段，按 Ctrl + Shift + I ，也可以实现同样的效果。<br>添加为列的字段会在数据列表中显示。</p>
<p><img src="https://mwchen.oss-cn-hangzhou.aliyuncs.com/MyBlog/TP-LINK/TP03/A4308.jpg"></p>
<h4 id="2-隐藏显示列"><a href="#2-隐藏显示列" class="headerlink" title="(2) 隐藏显示列"></a>(2) 隐藏显示列</h4><p>暂时不想查看的列，可以暂时隐藏起来。<br>在显示列的任意位置右键，取消列名的勾选，即可隐藏显示列。</p>
<p><img src="https://mwchen.oss-cn-hangzhou.aliyuncs.com/MyBlog/TP-LINK/TP03/A4309.jpg"></p>
<h4 id="3-删除显示列"><a href="#3-删除显示列" class="headerlink" title="(3) 删除显示列"></a>(3) 删除显示列</h4><p>不需要查看的字段，可以从显示列中删除。<br>右键需要删除的列，点击最下方的 Remove this Column 。</p>
<p><img src="https://mwchen.oss-cn-hangzhou.aliyuncs.com/MyBlog/TP-LINK/TP03/A4310.jpg"></p>
<p>注意：隐藏字段时，在列名栏的任意位置右键即可；而删除字段时，需要在指定的列名位置右键，以防误删。</p>
<h3 id="c-设置时间"><a href="#c-设置时间" class="headerlink" title="(c) 设置时间"></a>(c) 设置时间</h3><p>数据包列表栏的时间这一列，默认显示格式看起来很不方便，我们可以调整时间的显示格式。<br>点击工具栏的视图，选择时间显示格式，设置你喜欢的格式。</p>
<p><img src="https://mwchen.oss-cn-hangzhou.aliyuncs.com/MyBlog/TP-LINK/TP03/A4311.jpg"></p>
<h3 id="d-标记数据包"><a href="#d-标记数据包" class="headerlink" title="(d) 标记数据包"></a>(d) 标记数据包</h3><p>对于某些比较重要的数据包，可以设置成高亮显示，以达到标记的目的。<strong>此功能可与导出数据包配合，导出数据包时选择 Marked packets only，以导出标记的数据包。</strong><br>选中需要标记的数据包，右键选择最上面的标记/取消标记。</p>
<p><img src="https://mwchen.oss-cn-hangzhou.aliyuncs.com/MyBlog/TP-LINK/TP03/A4312.jpg"></p>
<p>选中数据包，按 Ctrl + M 也可以实现同样的效果，按两次可以取消标记。</p>
<h3 id="e-导出数据包"><a href="#e-导出数据包" class="headerlink" title="(e) 导出数据包"></a>(e) 导出数据包</h3><p>演示快速抓包时，我们讲过保存数据包的操作，保存操作默认保存所有已经抓取的数据包。但有时候，我们只需要保存指定的数据包，这时候可以使用导出的功能。</p>
<h4 id="1-导出单个数据包"><a href="#1-导出单个数据包" class="headerlink" title="(1) 导出单个数据包"></a>(1) 导出单个数据包</h4><p>选中数据包，点击左上角的文件，点击导出特定分组。</p>
<p><img src="https://mwchen.oss-cn-hangzhou.aliyuncs.com/MyBlog/TP-LINK/TP03/A4313.jpg"></p>
<p>在导出分组界面，选择第二个 Selected packets only，只保存选中的数据包。</p>
<p><img src="https://mwchen.oss-cn-hangzhou.aliyuncs.com/MyBlog/TP-LINK/TP03/A4314.jpg"></p>
<h4 id="2-导出多个数据包"><a href="#2-导出多个数据包" class="headerlink" title="(2) 导出多个数据包"></a>(2) 导出多个数据包</h4><p>有时候我们需要导出多个数据包，Wireshark 有一个导出标记的数据包的功能，我们将需要导出的数据包都标记起来，就可以同时导出多个数据包。<br>点击左上角的文件，点击导出特定分组。</p>
<p><img src="https://mwchen.oss-cn-hangzhou.aliyuncs.com/MyBlog/TP-LINK/TP03/A4315.jpg"></p>
<p>在导出分组界面，勾选第三个 Marked packets only，只导出标记的数据包。</p>
<p><img src="https://mwchen.oss-cn-hangzhou.aliyuncs.com/MyBlog/TP-LINK/TP03/A4316.jpg"></p>
<h3 id="f-开启混杂模式"><a href="#f-开启混杂模式" class="headerlink" title="(f) 开启混杂模式"></a>(f) 开启混杂模式</h3><p>局域网的所有流量都会发送给我们的电脑，默认情况下，我们的电脑只会对自己 mac 的流量进行解包，而丢弃其他 mac 的数据包。<br>开启混杂模式后，我们就可以解析其他 mac 的数据包。因此，我们使用 Wireshark 时，通常都会开启混杂模式。<br>点击菜单栏的捕获按钮，点击选项。</p>
<p><img src="https://mwchen.oss-cn-hangzhou.aliyuncs.com/MyBlog/TP-LINK/TP03/A4317.jpg"></p>
<p>勾选在所有接口上使用混杂模式。</p>
<p><img src="https://mwchen.oss-cn-hangzhou.aliyuncs.com/MyBlog/TP-LINK/TP03/A4318.jpg"></p>
<h2 id="D-过滤器操作"><a href="#D-过滤器操作" class="headerlink" title="(D) 过滤器操作"></a>(D) 过滤器操作</h2><p>过滤器是 Wireshark 的核心功能，也是我们平时使用最多的一个功能。Wireshark 提供了两个过滤器：“抓包过滤器”和“显示过滤器”。两个过滤器的过滤思路不同。<br>抓包过滤器：重点在动作，需要的包我才抓，不需要的我就不抓。<br>显示过滤器：重点在数据的展示，包已经抓了，只是不显示出来。</p>
<h3 id="a-抓包过滤器"><a href="#a-抓包过滤器" class="headerlink" title="(a) 抓包过滤器"></a>(a) 抓包过滤器</h3><p>抓包过滤器在抓包前使用，它的过滤有一个基本的语法格式：BPF 语法格式。</p>
<h4 id="1-BPF-语法"><a href="#1-BPF-语法" class="headerlink" title="(1) BPF 语法"></a>(1) BPF 语法</h4><p>BPF (全称 Berkeley Packet Filter)，中文叫伯克利封包过滤器，它有四个核心元素：类型、方向、协议 和 逻辑运算符。</p>
<ol>
<li>类型 Type：主机 (host)、网段 (net)、端口 (port)</li>
<li>方向 Dir：源地址 (src)、目标地址 (dst)</li>
<li>协议 Proto：各种网络协议，比如：tcp、udp、http</li>
<li>逻辑运算符：与 (&amp;&amp;) 、或 (||)、非 (!)</li>
</ol>
<p>四个元素可以自由组合，比如：</p>
<ol>
<li><code>src host 192.168.31.1</code> ：抓取源 IP 为 192.168.31.1 的数据包</li>
<li><code>tcp || udp</code> ：抓取 TCP 或者 UDP 协议的数据包</li>
</ol>
<h4 id="2-使用方式"><a href="#2-使用方式" class="headerlink" title="(2) 使用方式"></a>(2) 使用方式</h4><p>使用抓包过滤器时，需要先停止抓包，设置完过滤规则后，再开始抓包。<br>停止抓包的前提下，点击工具栏的捕获按钮，点击选项。</p>
<p><img src="https://mwchen.oss-cn-hangzhou.aliyuncs.com/MyBlog/TP-LINK/TP03/A4319.jpg"></p>
<p>在弹出的捕获选项界面，最下方的输入框中输入过滤语句，点击开始即可抓包。</p>
<p><img src="https://mwchen.oss-cn-hangzhou.aliyuncs.com/MyBlog/TP-LINK/TP03/A4320.jpg"></p>
<p>提示：抓包过滤器的输入框，会自动检测语法，绿色代表语法正确，红色代表语法错误。</p>
<h3 id="b-显示过滤器"><a href="#b-显示过滤器" class="headerlink" title="(b) 显示过滤器"></a>(b) 显示过滤器</h3><p>显示过滤器在抓包后或者抓包的过程中使用。</p>
<h4 id="1-语法结构"><a href="#1-语法结构" class="headerlink" title="(1) 语法结构"></a>(1) 语法结构</h4><p>显示过滤器的语法包含 5 个核心元素：IP、端口、协议、比较运算符和逻辑运算符。</p>
<ol>
<li>IP 地址：ip.addr、ip.src、ip.dst</li>
<li>端口：tcp.port、tcp.srcport、tcp.dstport</li>
<li>协议：tcp、udp、http</li>
<li>比较运算符：&gt;、 &lt;、==、&gt;=、&lt;=、!=</li>
<li>逻辑运算符：and、or、not、xor (有且仅有一个条件被满足)</li>
</ol>
<p>5 个核心元素可以自由组合，比如：</p>
<ol>
<li><code>ip.addr == 192.168.32.121</code> ： 显示 IP 地址为 192.168.32.121 的数据包 </li>
<li><code>tcp.port == 80</code> ：显示端口为 80 的数据包</li>
</ol>
<h4 id="2-使用方式-1"><a href="#2-使用方式-1" class="headerlink" title="(2) 使用方式"></a>(2) 使用方式</h4><p>在过滤栏输入过滤语句，修改后立即生效。</p>
<p><img src="https://mwchen.oss-cn-hangzhou.aliyuncs.com/MyBlog/TP-LINK/TP03/A4321.jpg"></p>
<p>提示：过滤栏有自动纠错功能，绿色表示语法正确，红色表示语法错误。</p>
<h3 id="c-过滤表达式"><a href="#c-过滤表达式" class="headerlink" title="(c) 过滤表达式"></a>(c) 过滤表达式</h3><p>这里整理了一下常用的过滤表达式：</p>
<table>
<thead>
<tr>
<th>过滤表达式</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>tcp</td>
<td>筛选 tcp 协议的数据包</td>
</tr>
<tr>
<td>!tcp</td>
<td>筛选除 tcp 协议以外的数据包</td>
</tr>
<tr>
<td>tcp.port == 80</td>
<td>筛选端口为 80 的数据包</td>
</tr>
<tr>
<td>tcp.port == 12345 &amp;&amp; tcp.port == 80</td>
<td>筛选 12345 端口和 80 端口的数据包</td>
</tr>
<tr>
<td>tcp.srcport == 12345 &amp;&amp; tcp.dstport == 80</td>
<td>筛选从 12345 端口 发往 80 端口的数据包</td>
</tr>
<tr>
<td>ip.addr == 192.168.1.1</td>
<td>筛选 ip 地址为 192.168.1.1 的数据包</td>
</tr>
<tr>
<td>ip.addr == 192.168.1.1 &amp;&amp; ip.addr == 192.168.1.2</td>
<td>筛选 ip 地址为 192.168.1.1 和 192.168.1.2 的数据包</td>
</tr>
<tr>
<td>http.request.method == GET</td>
<td>筛选 HTTP 为 GET 请求方式的数据包</td>
</tr>
<tr>
<td>ip.src == 192.168.1.102</td>
<td>筛选源地址为 192.168.1.102 的数据包</td>
</tr>
<tr>
<td>http.request.uri matches ISAPI</td>
<td>匹配 http 请求中含有 ISAPI 字段的请求信息</td>
</tr>
<tr>
<td>http</td>
<td>筛选 http 协议的数据包</td>
</tr>
</tbody></table>
<h1 id="二-Scapy"><a href="#二-Scapy" class="headerlink" title="二. Scapy"></a>二. Scapy</h1><p>Scapy 是一个强大的，用 Python 编写的交互式数据包处理程序。可以让用户发送、嗅探、分析和伪造网络包，从而用来侦测、扫描和向网络发动攻击；可以轻松地处理扫描 (scanning)、路由跟踪 (tracerouting)、探测  (probing)、单元测试 (unit tests)、攻击 (attacks) 和发现网络 (network discorvery) 之类的经典任务。</p>
<h2 id="A-基本操作"><a href="#A-基本操作" class="headerlink" title="(A) 基本操作"></a>(A) 基本操作</h2><p>这里介绍一下 Scapy 的一些基本操作。</p>
<h3 id="a-查看信息"><a href="#a-查看信息" class="headerlink" title="(a) 查看信息"></a>(a) 查看信息</h3><p><strong>(1) 查看 scapy 的配置参数</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scapy.all <span class="keyword">import</span> *</span><br><span class="line">print(conf)</span><br></pre></td></tr></table></figure>

<p><strong>(2) 查看 scapy 支持的所有命令</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scapy.all <span class="keyword">import</span> *</span><br><span class="line">print(lsc())</span><br></pre></td></tr></table></figure>

<p><strong>(3) 查看网络协议及其详细字段</strong></p>
<p>ls() 命令无参数的情况下，用来查看可以实现的所有的网络协议。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scapy.all <span class="keyword">import</span> *</span><br><span class="line">print(ls())</span><br></pre></td></tr></table></figure>

<p>ls() 命令带参数的情况下，用来查看参数(网络协议)的字段详情。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scapy.all <span class="keyword">import</span> *</span><br><span class="line">print(ls(UDP()))</span><br></pre></td></tr></table></figure>

<p>结果为</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sport      : ShortEnumField                      = <span class="number">53</span>              (<span class="string">&#x27;53&#x27;</span>)</span><br><span class="line">dport      : ShortEnumField                      = <span class="number">53</span>              (<span class="string">&#x27;53&#x27;</span>)</span><br><span class="line">len        : ShortField                          = <span class="literal">None</span>            (<span class="string">&#x27;None&#x27;</span>)</span><br><span class="line">chksum     : XShortField                         = <span class="literal">None</span>            (<span class="string">&#x27;None&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><strong>(4) 实例化数据包并查看默认配置</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scapy.all <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#实例化一个IP数据包,调用data.show方法查看数据包的默认字段</span></span><br><span class="line"></span><br><span class="line">data = IP()</span><br><span class="line">data.show()</span><br></pre></td></tr></table></figure>

<h3 id="b-发送与接收数据"><a href="#b-发送与接收数据" class="headerlink" title="(b) 发送与接收数据"></a>(b) 发送与接收数据</h3><h4 id="1-send-与-sendp"><a href="#1-send-与-sendp" class="headerlink" title="(1) send 与 sendp"></a>(1) send 与 sendp</h4><p>send() 方法在第三层(网络层)工作，处理路由数据与第二层数据。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scapy.all <span class="keyword">import</span> *</span><br><span class="line">send(IP(dst=<span class="string">&quot;1.2.3.4&quot;</span>)/ICMP())</span><br><span class="line">resp = send(IP(dst=<span class="string">&quot;1.2.3.4&quot;</span>)/ICMP(), return_packets=<span class="literal">True</span>)</span><br><span class="line">print(resp)</span><br></pre></td></tr></table></figure>

<p>sendp() 方法在第二层(数据链路层)工作，需要指定正确的接口与数据链路层协议。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scapy.all <span class="keyword">import</span> *</span><br><span class="line">sendp(Ether()/IP(dst=<span class="string">&quot;1.2.3.4&quot;</span>,ttl=(<span class="number">1</span>,<span class="number">4</span>)), iface=<span class="string">&quot;Intel(R) Ethernet Connection (14) I219-V&quot;</span>)  <span class="comment">#iface填要用的网卡</span></span><br><span class="line">resp = sendp(Ether()/IP(dst=<span class="string">&quot;1.2.3.4&quot;</span>,ttl=(<span class="number">1</span>,<span class="number">4</span>)), return_packets=<span class="literal">True</span>, iface=<span class="string">&quot;Intel(R) Ethernet Connection (14) I219-V&quot;</span>)</span><br><span class="line">print(resp)</span><br></pre></td></tr></table></figure>

<h4 id="2-sr-与-sr1"><a href="#2-sr-与-sr1" class="headerlink" title="(2) sr 与 sr1"></a>(2) sr 与 sr1</h4><p>sr() 方法发送数据包与接收数据，返回值为两个，一个是应答返回的数据包，一个是未应答的数据包。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scapy.all <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">ans为返回的应答数据包</span></span><br><span class="line"><span class="string">unans为发送的未应答的数据包</span></span><br><span class="line"><span class="string">调用ans.summary()与unans.summary()查看简单的数据包信息，比&quot;.show&quot;的信息要少</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">ans, unans = sr(IP(dst=<span class="string">&quot;192.168.3.1&quot;</span>)/TCP(dport=[<span class="number">21</span>,<span class="number">22</span>,<span class="number">23</span>]))</span><br><span class="line">ans.summary()</span><br><span class="line">unans.summary()</span><br></pre></td></tr></table></figure>

<p>sr1() 方法是 sr() 的特殊用法，仅仅返回一个参数，就是所收到的应答的数据包。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scapy.all <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">resp为返回的应答数据包</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">resp = sr1(IP(dst=<span class="string">&quot;www.slashdot.org&quot;</span>)/ICMP())</span><br></pre></td></tr></table></figure>

<p>注：srp() 方法与 srp1() 方法是针对二层数据的发送方法，区别也就是 sr() 与 sr1() 的区别，即返回参数是否包含未应答的发送数据。</p>
<h4 id="3-fuzz"><a href="#3-fuzz" class="headerlink" title="(3) fuzz"></a>(3) fuzz</h4><p>fuzz() 方法是用来创建随机的合理参数的数据包，比如下面这个：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scapy.all <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">loop字段代表循环发送</span></span><br><span class="line"><span class="string">fuzz(随机的协议类)</span></span><br><span class="line"><span class="string">这里咱们就构建了一个除了目标地址与NTP版本为4之外的一个随机数据包</span></span><br><span class="line"><span class="string">（如果您在 IP 层使用 fuzz()，则 src 和 dst 参数不会是随机的，如果需要的话，请使用 RandIP()）</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">send(IP(dst=<span class="string">&quot;127.0.0.1&quot;</span>)/fuzz(UDP()/NTP(version=<span class="number">4</span>)),loop=<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<h3 id="c-读写-pcap-pcapng-文件"><a href="#c-读写-pcap-pcapng-文件" class="headerlink" title="(c) 读写 pcap/pcapng 文件"></a>(c) 读写 pcap/pcapng 文件</h3><p><strong>读取 pcap/pacpng 文件</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">r_pkts = rdpcap(<span class="string">&#x27;test.pcap&#x27;</span>)</span><br><span class="line">r_pkts = rdpcapng(<span class="string">&#x27;test.pcapng&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><strong>将报文保存为 pcap/pcapng 文件</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wrpcap(<span class="string">&quot;test.pcap&quot;</span>, package)  <span class="comment">#将报文package保存为test.pcap文件</span></span><br><span class="line">wrpcapng(<span class="string">&quot;test.pcapng&quot;</span>, package)  <span class="comment">#将报文package保存为test.pcapng文件</span></span><br></pre></td></tr></table></figure>

<h3 id="d-sniff-抓包"><a href="#d-sniff-抓包" class="headerlink" title="(d) sniff 抓包"></a>(d) sniff 抓包</h3><p><strong>语法</strong></p>
<p>scapy 的 sniff 函数与 wireshark、tcpdump 工具类似，能够捕获指定接口或类型的报文并进行解析。sniff() 函数语法及参数如下，参考 help(sniff):</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sniff(count=<span class="number">0</span>, store=<span class="number">1</span>, offline=<span class="literal">None</span>, prn=<span class="literal">None</span>, filter=<span class="literal">None</span>, L2socket=<span class="literal">None</span>, timeout=<span class="literal">None</span>, opened_socket=<span class="literal">None</span>, stop_filter=<span class="literal">None</span>, iface=<span class="literal">None</span>, *args, **kargs)</span><br></pre></td></tr></table></figure>

<p>filter：用于指定过滤条件，只有符合条件的数据包才会被抓取。使用 wireshark 里面的过滤语法。</p>
<p>iface：用于指定监听的网络接口，即写入要检测的网卡名。默认情况下将监听所有的网络接口。</p>
<p>prn：用于指定抓取到每个数据包后执行的函数。可以在该函数中对抓取到的数据包进行处理或分析。</p>
<p>count：用于指定抓取数据包的数量。默认值为 0，表示持续监听。</p>
<p>timeout：用于指定抓取数据包的超时时间，即在给定的时间后停止嗅探。默认情况下将持续监听。</p>
<p>store：用于指定将抓取到的数据包保存或者丢弃，1 保存，0 丢弃。</p>
<p><strong>实例：嗅探是否收到 ICMP 报文</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scapy.all <span class="keyword">import</span> sniff</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">count_packets</span>(<span class="params">pkt</span>):</span></span><br><span class="line">    <span class="keyword">global</span> icmp_count</span><br><span class="line">    <span class="keyword">if</span> pkt.haslayer(<span class="string">&#x27;ICMP&#x27;</span>):</span><br><span class="line">        icmp_count += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">icmp_count = <span class="number">0</span></span><br><span class="line">pkt = sniff(iface=<span class="string">&#x27;Intel(R) Ethernet Connection (14) I219-V&#x27;</span>, timeout=<span class="number">60</span>, prn=count_packets)  <span class="comment">#PC网卡名称</span></span><br><span class="line">print(pkt)</span><br><span class="line">sum = len(pkt)</span><br><span class="line">icmp_percent = (icmp_count / sum) * <span class="number">100</span></span><br><span class="line">print(<span class="string">&quot;一分钟内抓取到的流量包的总数: %d\nICMP包的数量: %d; 占比：%.2f%%&quot;</span> % (sum, icmp_count, icmp_percent))</span><br></pre></td></tr></table></figure>

<h2 id="B-构造协议报文"><a href="#B-构造协议报文" class="headerlink" title="(B) 构造协议报文"></a>(B) 构造协议报文</h2><p>这里介绍一种运用 wireshark 和 scapy 构造任意协议报文的方法。</p>
<p><strong>第一步：抓取报文并进行层级 (layer) 解析</strong></p>
<p>我们以 ping 命令对应的 ICMP 报文为例，首先我们就实际抓取一个 ping 命令对应的 ICMP 的 echo-request 报文。</p>
<p><img src="https://mwchen.oss-cn-hangzhou.aliyuncs.com/MyBlog/TP-LINK/TP03/A4322.jpg"></p>
<p>用 wireshark 抓取该报文后，单独另存为一个 pcapng 文件，然后执行以下代码段进行层级解析。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scapy.all <span class="keyword">import</span> *</span><br><span class="line">pkts = rdpcap(<span class="string">&#x27;packet.pcapng&#x27;</span>)  <span class="comment">#报文的pcapng文件</span></span><br><span class="line">pkts[<span class="number">0</span>].show()  <span class="comment">#序号为1报文(通过wireshark查看)</span></span><br></pre></td></tr></table></figure>

<p>可以得到类似以下结果</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">###[ Ethernet ]### </span></span><br><span class="line">  dst       = <span class="number">6</span>c:b1:<span class="number">58</span>:<span class="number">24</span>:<span class="number">3</span>d:<span class="number">88</span></span><br><span class="line">  src       = <span class="number">58</span>:<span class="number">11</span>:<span class="number">22</span>:<span class="number">0</span>f:<span class="number">5</span>d:<span class="number">4</span>c</span><br><span class="line">  type      = IPv4</span><br><span class="line"><span class="comment">###[ IP ]### </span></span><br><span class="line">     version   = <span class="number">4</span></span><br><span class="line">     ihl       = <span class="number">5</span></span><br><span class="line">     tos       = <span class="number">0x0</span></span><br><span class="line">     len       = <span class="number">60</span></span><br><span class="line">     id        = <span class="number">3259</span></span><br><span class="line">     flags     = </span><br><span class="line">     frag      = <span class="number">0</span></span><br><span class="line">     ttl       = <span class="number">128</span></span><br><span class="line">     proto     = icmp</span><br><span class="line">     chksum    = <span class="number">0x0</span></span><br><span class="line">     src       = <span class="number">10.15</span><span class="number">.168</span><span class="number">.112</span></span><br><span class="line">     dst       = <span class="number">172.29</span><span class="number">.150</span><span class="number">.144</span></span><br><span class="line">     \options   \</span><br><span class="line"><span class="comment">###[ ICMP ]### </span></span><br><span class="line">        type      = echo-request</span><br><span class="line">        code      = <span class="number">0</span></span><br><span class="line">        chksum    = <span class="number">0x4d3e</span></span><br><span class="line">        id        = <span class="number">0x1</span></span><br><span class="line">        seq       = <span class="number">0x1d</span></span><br><span class="line">        unused    = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="comment">###[ Raw ]### </span></span><br><span class="line">           load      = <span class="string">&#x27;abcdefghijklmnopqrstuvwabcdefghi&#x27;</span></span><br></pre></td></tr></table></figure>

<p>通过这个可以看到需要构造的报文层级，从抓包结果来看具有 Ethernet、IP、ICMP、Raw 四层，实践时发现要构造的是 IP 和 ICMP 两层。</p>
<p><strong>第二步：了解脚本构造的各层级需要指定的参数</strong></p>
<p>执行</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scapy.all <span class="keyword">import</span> *</span><br><span class="line">print(ls())</span><br></pre></td></tr></table></figure>

<p>能查看 scapy 可以构造的层级。若要具体查看比如 IP 层的参数，则在 ls() 输入协议名+括号，例如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scapy.all <span class="keyword">import</span> *</span><br><span class="line">print(ls(IP()))</span><br></pre></td></tr></table></figure>

<p>由此可以查看 IP 和 ICMP 各自需要输入的参数变量名，而参数的具体值可以参考之前抓取的报文。</p>
<p><strong>第三步：构造报文</strong></p>
<p>通过前两步获取的信息，经过调试后，成功构造并发送了一个正常的 ICMP 报文。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scapy.all <span class="keyword">import</span> *</span><br><span class="line">ip = IP(src=<span class="string">&#x27;10.15.168.112&#x27;</span>, dst=<span class="string">&#x27;172.29.150.144&#x27;</span>)</span><br><span class="line">icmp = ICMP(type=<span class="number">8</span>, code=<span class="number">0</span>, chksum=<span class="literal">None</span>, id=<span class="number">0x1</span>, seq=<span class="number">0x1d</span>)</span><br><span class="line">load = <span class="string">&#x27;abcdefghijklmnopqrstuvwabcdefghi&#x27;</span></span><br><span class="line">packet = ip/icmp/load  <span class="comment">#scapy中用“/”构建层级</span></span><br><span class="line">rep = sr1(packet)</span><br><span class="line">print(rep)</span><br></pre></td></tr></table></figure>

<h2 id="C-应用实例"><a href="#C-应用实例" class="headerlink" title="(C) 应用实例"></a>(C) 应用实例</h2><p>这里给出了一个运用 scapy 模块，发送正确与异常的 ICMP 和 ARP 报文，并记录结果的脚本实例。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scapy.all <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os, time, shutil, datetime, random</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test_Base</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.send_legal_packet_path = os.path.dirname(os.path.abspath(__file__)) + <span class="string">r&#x27;\testInfo&#x27;</span> + <span class="string">r&#x27;\legal_packet_send&#x27;</span></span><br><span class="line">        self.send_illegal_packet_path = os.path.dirname(os.path.abspath(__file__)) + <span class="string">r&#x27;\testInfo&#x27;</span> + <span class="string">r&#x27;\illegal_packet_send&#x27;</span></span><br><span class="line">        self.legal_packet_path = os.path.dirname(os.path.abspath(__file__)) + <span class="string">r&#x27;\testInfo&#x27;</span> + <span class="string">r&#x27;\legal_packet_answer&#x27;</span></span><br><span class="line">        self.illegal_packet_path = os.path.dirname(os.path.abspath(__file__)) + <span class="string">r&#x27;\testInfo&#x27;</span> + <span class="string">r&#x27;\illegal_packet_answer&#x27;</span></span><br><span class="line">        self.time_now = str(datetime.datetime.now().strftime(<span class="string">&#x27;%Y-%m-%d %X&#x27;</span>))</span><br><span class="line">        self.test_record = os.path.dirname(os.path.abspath(__file__)) + <span class="string">r&#x27;\testInfo&#x27;</span> + <span class="string">r&#x27;\test_info.txt&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_testInfo_dir</span>(<span class="params">self</span>):</span></span><br><span class="line">        main_path = os.path.dirname(os.path.abspath(__file__)) + <span class="string">r&#x27;\testInfo&#x27;</span></span><br><span class="line">        isExists = os.path.exists(main_path)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> isExists:</span><br><span class="line">            os.makedirs(main_path)</span><br><span class="line"></span><br><span class="line">        send_legal_packet = self.send_legal_packet_path</span><br><span class="line">        send_illegal_packet = self.send_illegal_packet_path</span><br><span class="line">        legal_packet = self.legal_packet_path</span><br><span class="line">        illegal_packet = self.illegal_packet_path</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> [send_legal_packet, send_illegal_packet, legal_packet, illegal_packet]:</span><br><span class="line">            isExists = os.path.exists(i)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> isExists:</span><br><span class="line">                os.makedirs(i)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> open(self.test_record, <span class="string">&#x27;a&#x27;</span>) <span class="keyword">as</span> f1:</span><br><span class="line">            msg = <span class="string">&#x27;&#x27;</span></span><br><span class="line">            f1.write(msg)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">save_legal_send_packet_file</span>(<span class="params">self, file_name</span>):</span></span><br><span class="line">        <span class="comment">#须先执行create_testInfo_dir</span></span><br><span class="line">        shutil.move(file_name, self.send_legal_packet_path)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">save_illegal_send_packet_file</span>(<span class="params">self, file_name</span>):</span></span><br><span class="line">        <span class="comment">#须先执行create_testInfo_dir</span></span><br><span class="line">        shutil.move(file_name, self.send_illegal_packet_path)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">save_legal_packet_file</span>(<span class="params">self, file_name</span>):</span></span><br><span class="line">        <span class="comment">#须先执行create_testInfo_dir</span></span><br><span class="line">        shutil.move(file_name, self.legal_packet_path)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">save_illegal_packet_file</span>(<span class="params">self, file_name</span>):</span></span><br><span class="line">        <span class="comment">#须先执行create_testInfo_dir</span></span><br><span class="line">        shutil.move(file_name, self.illegal_packet_path)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">time_temp_str</span>(<span class="params">self</span>):</span></span><br><span class="line">        time_temp = self.time_now.strip().replace(<span class="string">&#x27;-&#x27;</span>, <span class="string">&#x27;_&#x27;</span>)</span><br><span class="line">        time_temp = time_temp.strip().replace(<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;_&#x27;</span>)</span><br><span class="line">        time_temp = time_temp.strip().replace(<span class="string">&#x27;:&#x27;</span>, <span class="string">&#x27;_&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> time_temp</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">write_msg</span>(<span class="params">self, msg</span>):</span></span><br><span class="line">        <span class="comment"># 须先执行create_testInfo_dir</span></span><br><span class="line">        <span class="keyword">with</span> open(self.test_record, <span class="string">&#x27;a&#x27;</span>) <span class="keyword">as</span> f1:</span><br><span class="line">            msg_a = msg + <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">            f1.write(msg_a)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Send_Legal_Packet</span>(<span class="params">Test_Base</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, src_ip, dst_ip</span>):</span></span><br><span class="line">        super().__init__()</span><br><span class="line">        self.src_ip = src_ip</span><br><span class="line">        self.dst_ip = dst_ip</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">send_legal_icmp</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.time_now = str(datetime.datetime.now().strftime(<span class="string">&#x27;%Y-%m-%d %X&#x27;</span>))</span><br><span class="line">        ip = IP(src=self.src_ip, dst=self.dst_ip)</span><br><span class="line">        icmp = ICMP(type=<span class="number">8</span>, code=<span class="number">0</span>, chksum=<span class="literal">None</span>, id=<span class="number">0x1</span>, seq=<span class="number">0x1d</span>)</span><br><span class="line">        packet = ip / icmp</span><br><span class="line"></span><br><span class="line">        <span class="comment"># save send_packet file</span></span><br><span class="line">        time_now = self.time_now</span><br><span class="line">        time_temp = self.time_temp_str()</span><br><span class="line">        send_file_name = <span class="string">&#x27;icmp_send_&#x27;</span> + time_temp + <span class="string">&#x27;.pcap&#x27;</span></span><br><span class="line">        wrpcap(send_file_name, packet)</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">        self.save_legal_send_packet_file(send_file_name)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># send packet and receive answer</span></span><br><span class="line">        ans_return = sr1(packet, timeout=<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">#test record and save file</span></span><br><span class="line">        answer_file_name = <span class="string">&#x27;icmp_answer_&#x27;</span> + time_temp + <span class="string">&#x27;.pcap&#x27;</span></span><br><span class="line">        wrpcap(answer_file_name, ans_return)</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">        self.save_legal_packet_file(answer_file_name)</span><br><span class="line">        test_msg = time_now + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;send legal packet icmp, reply is &#x27;</span> + str(ans_return)</span><br><span class="line">        self.write_msg(test_msg)</span><br><span class="line">        print(ans_return)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">send_legal_arp</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.time_now = str(datetime.datetime.now().strftime(<span class="string">&#x27;%Y-%m-%d %X&#x27;</span>))</span><br><span class="line">        packet = Ether(dst=<span class="string">&#x27;ff:ff:ff:ff:ff:ff&#x27;</span>) / ARP(pdst=self.dst_ip)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># save send_packet file</span></span><br><span class="line">        time_now = self.time_now</span><br><span class="line">        time_temp = self.time_temp_str()</span><br><span class="line">        send_file_name = <span class="string">&#x27;arp_send_&#x27;</span> + time_temp + <span class="string">&#x27;.pcap&#x27;</span></span><br><span class="line">        wrpcap(send_file_name, packet)</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">        self.save_legal_send_packet_file(send_file_name)</span><br><span class="line"></span><br><span class="line">        ans_return = srp1(packet, timeout=<span class="number">4</span>, verbose=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">        answer_file_name = <span class="string">&#x27;arp_answer_&#x27;</span> + time_temp + <span class="string">&#x27;.pcap&#x27;</span></span><br><span class="line">        wrpcap(answer_file_name, ans_return)</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">        self.save_legal_packet_file(answer_file_name)</span><br><span class="line">        test_msg = time_now + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;send legal packet arp, reply is &#x27;</span> + str(ans_return)</span><br><span class="line">        self.write_msg(test_msg)</span><br><span class="line">        print(ans_return)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Send_Illegal_Packet</span>(<span class="params">Test_Base</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, src_ip, dst_ip</span>):</span></span><br><span class="line">        super().__init__()</span><br><span class="line">        self.src_ip = src_ip</span><br><span class="line">        self.dst_ip = dst_ip</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">send_illegal_icmp</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.time_now = str(datetime.datetime.now().strftime(<span class="string">&#x27;%Y-%m-%d %X&#x27;</span>))</span><br><span class="line">        ip = IP(src=self.src_ip, dst=self.dst_ip)</span><br><span class="line"></span><br><span class="line">        <span class="comment">#构造非法参数列表</span></span><br><span class="line">        illegal_type=[<span class="number">1</span>, <span class="number">20</span>, <span class="number">30</span>, <span class="number">50</span>, <span class="number">100</span>]</span><br><span class="line">        illegal_chksum = random.randint(<span class="number">1</span>, <span class="number">20</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">#选用非法参数具体值</span></span><br><span class="line">        type_chosen = illegal_type[random.randint(<span class="number">0</span>, len(illegal_type)<span class="number">-1</span>)]</span><br><span class="line">        checksum_chosen = illegal_chksum</span><br><span class="line"></span><br><span class="line">        icmp = ICMP(type=type_chosen, code=<span class="number">0</span>, chksum=checksum_chosen, id=<span class="number">0x1</span>, seq=<span class="number">0x1d</span>)</span><br><span class="line">        packet = ip / icmp</span><br><span class="line"></span><br><span class="line">        <span class="comment"># save send_packet file</span></span><br><span class="line">        time_now = self.time_now</span><br><span class="line">        time_temp = self.time_temp_str()</span><br><span class="line">        send_file_name = <span class="string">&#x27;illegal_icmp_send_&#x27;</span> + time_temp + <span class="string">&#x27;.pcap&#x27;</span></span><br><span class="line">        wrpcap(send_file_name, packet)</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">        self.save_illegal_send_packet_file(send_file_name)</span><br><span class="line"></span><br><span class="line">        ans_return = sr1(packet, timeout=<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">#test record and save file</span></span><br><span class="line">        file_name = <span class="string">&#x27;icmp_answer_&#x27;</span> + time_temp + <span class="string">&#x27;.pcap&#x27;</span></span><br><span class="line">        wrpcap(file_name, ans_return)</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">        self.save_illegal_packet_file(file_name)</span><br><span class="line">        test_msg = time_now + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;send illegal packet icmp, reply is &#x27;</span> + str(ans_return)</span><br><span class="line">        self.write_msg(test_msg)</span><br><span class="line">        print(ans_return)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">send_illegal_arp</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.time_now = str(datetime.datetime.now().strftime(<span class="string">&#x27;%Y-%m-%d %X&#x27;</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment">#构造非法参数列表</span></span><br><span class="line">        illegal_mac = [<span class="string">&#x27;00:00:00:00:00:00&#x27;</span>, <span class="string">&#x27;00:01:00:01:00:01:00:01&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment">#选用非法参数具体值</span></span><br><span class="line">        mac_chosen = illegal_mac[random.randint(<span class="number">0</span>, len(illegal_mac)<span class="number">-1</span>)]</span><br><span class="line"></span><br><span class="line">        packet = Ether(dst=mac_chosen) / ARP(pdst=self.dst_ip)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># save send_packet file</span></span><br><span class="line">        time_now = self.time_now</span><br><span class="line">        time_temp = self.time_temp_str()</span><br><span class="line">        send_file_name = <span class="string">&#x27;illegal_arp_send_&#x27;</span> + time_temp + <span class="string">&#x27;.pcap&#x27;</span></span><br><span class="line">        wrpcap(send_file_name, packet)</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">        self.save_illegal_send_packet_file(send_file_name)</span><br><span class="line"></span><br><span class="line">        ans_return = srp1(packet, timeout=<span class="number">4</span>, verbose=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">        answer_file_name = <span class="string">&#x27;arp_answer_&#x27;</span> + time_temp + <span class="string">&#x27;.pcap&#x27;</span></span><br><span class="line">        wrpcap(answer_file_name, ans_return)</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">        self.save_illegal_packet_file(answer_file_name)</span><br><span class="line">        test_msg = time_now + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;send illegal packet arp, reply is &#x27;</span> + str(ans_return)</span><br><span class="line">        self.write_msg(test_msg)</span><br><span class="line">        print(ans_return)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pre_test</span>():</span></span><br><span class="line">    my_pretest = Test_Base()</span><br><span class="line">    my_pretest.create_testInfo_dir()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main_test</span>():</span></span><br><span class="line">    mytest = Test_Base()</span><br><span class="line">    mytest.create_testInfo_dir()</span><br><span class="line"></span><br><span class="line">    src_ip = input(<span class="string">&#x27;请输入报文源ip：&#x27;</span>)</span><br><span class="line">    dst_ip = input(<span class="string">&#x27;请输入报文目的ip:&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    print(<span class="string">&#x27;开始发送合法的icmp报文···&#x27;</span>)</span><br><span class="line">    mytest1 = Send_Legal_Packet(src_ip=src_ip, dst_ip=dst_ip)</span><br><span class="line">    mytest1.send_legal_icmp()</span><br><span class="line">    print(<span class="string">&#x27;开始发送合法的arp报文···&#x27;</span>)</span><br><span class="line">    mytest1.send_legal_arp()</span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    print(<span class="string">&#x27;开始发送异常icmp报文···&#x27;</span>)</span><br><span class="line">    mytest2 = Send_Illegal_Packet(src_ip=src_ip, dst_ip=dst_ip)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">        print(<span class="string">&#x27;第%d次发送异常icmp报文&#x27;</span> % (i+<span class="number">1</span>))</span><br><span class="line">        mytest2.send_illegal_icmp()</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">    print(<span class="string">&#x27;开始发送异常arp报文···&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">        print(<span class="string">&#x27;第%d次发送异常arp报文&#x27;</span> % (i+<span class="number">1</span>))</span><br><span class="line">        mytest2.send_illegal_arp()</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    print(<span class="string">&#x27;测试结束，请在testInfo文件夹中查看本次测试结果&#x27;</span>)</span><br><span class="line">    time.sleep(<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line"></span><br><span class="line">    main_test()</span><br></pre></td></tr></table></figure>


    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Python/" rel="tag"># Python</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2023/05/22/Python_Module01/" rel="prev" title="Python模块学习：requests·logging·pyinstaller·email">
      <i class="fa fa-chevron-left"></i> Python模块学习：requests·logging·pyinstaller·email
    </a></div>
      <div class="post-nav-item">
    <a href="/2023/08/20/pytest/" rel="next" title="Pytest使用指南">
      Pytest使用指南 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



        </div>
        

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Minwei Chen</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/next-boot.js"></script>


  















  

  

  

</body>
</html>
